define(["require","exports","@dojo/framework/shim/AbortController","../Error","../promiseUtils","./utils"],function(e,t,_,c,b,d){function f(e,t){e.delete(t)}function h(e){e=new c("AbortError",e=void 0===e?"Invocation cancellation":e);return e.dojoType="cancel",e}var o=d.MessageType.CLOSE,p=d.MessageType.ABORT,l=d.MessageType.INVOKE,v=d.MessageType.RESPONSE,r=d.MessageType.OPEN_PORT,n=(s.prototype.push=function(e){e.type===d.MessageType.ABORT?this._cancelledJobIds.add(e.jobId):(this._invokeMessages.push(e),null===this._timer&&(this._timer=setTimeout(this._process,0)))},s.prototype.clear=function(){this._invokeMessages.length=0,this._cancelledJobIds.clear(),this._timer=null},s.prototype._process=function(){this._timer=null;for(var e=0,t=this._invokeMessages;e<t.length;e++){var o=t[e];this._cancelledJobIds.has(o.jobId)||this._invoke(o)}this._cancelledJobIds.clear(),this._invokeMessages.length=0},s);function s(e){this._timer=null,this._cancelledJobIds=new Set,this._invokeMessages=[],this._invoke=e,this._timer=null,this._process=this._process.bind(this)}return i.connect=function(e){var t=new MessageChannel,e="function"==typeof e?new e:"default"in e&&"function"==typeof e.default?new e.default:e;return e.remoteClient=new i(t.port1,e,t),t.port2},i.prototype.close=function(){this._post({type:o}),this._close()},i.prototype.isBusy=function(){return 0<this._outJobs.size},i.prototype.invoke=function(o,s,e){var n=this,t=e&&e.signal,r=e&&e.transferList;if(!this._port)return b.reject(new c("remote-client:port-closed","Can't invoke(), port is closed"));if(t&&t.aborted)return b.reject(h());var i=d.newJobId(),a=function(){t&&t.removeEventListener("abort",a);var e=n._outJobs.get(i);e&&(f(n._outJobs,i),n._post({type:p,jobId:i}),e.reject(h()))};return t&&t.addEventListener("abort",a),b.create(function(e,t){n._outJobs.set(i,{resolve:e,reject:t}),n._post({type:l,jobId:i,methodName:o,abortable:!0},s,r)},a)},i.prototype.openPort=function(){function o(){f(s._outJobs,n),s._post({type:p,jobId:n})}var s=this,n=d.newJobId();return b.create(function(e,t){s._outJobs.set(n,{resolve:e,reject:t,signal:o}),s._post({type:r,jobId:n})},o)},i.prototype._close=function(){this._channel&&(this._channel=null),this._port.removeEventListener("message",this._onMessage),this._port.close(),this._outJobs.forEach(function(e){e.reject(h())}),this._inJobs.clear(),this._outJobs.clear(),this._queue.clear(),this._port=this._client=null},i.prototype._onMessage=function(e){var t=d.receiveMessage(e);if(t)switch(t.type){case v:this._onResponse(t);break;case l:this._queue.push(t);break;case p:this._onAbort(t);break;case o:this._close();break;case r:this._onOpenPort(t)}},i.prototype._onAbort=function(e){var t=this._inJobs,o=e.jobId,s=t.get(o);this._queue.push(e),s&&(s.controller&&s.controller.abort(),f(t,o))},i.prototype._onInvoke=function(e){var t,o,s=this,n=e.methodName,r=e.jobId,i=e.data,a=e.abortable?new _.default:null,c=this._inJobs,h=this._client,p=h[n];try{if(!p&&n&&-1!==n.indexOf("."))for(var l=n.split("."),u=0;u<l.length-1;u++)p=(h=h[l[u]])[l[u+1]];if("function"!=typeof p)throw new TypeError(n+" is not a function");t=p.call(h,i,{client:this,signal:a?a.signal:null})}catch(e){return void this._post({type:v,jobId:r,error:d.toInvokeError(e)})}b.isThenable(t)?(c.set(r,{controller:a,promise:t}),o=function(){c.has(r)&&(a.signal.removeEventListener("abort",o),t.cancel(),f(c,r))},a.signal.addEventListener("abort",o),t.then(function(e){c.has(r)&&(f(c,r),s._post({type:v,jobId:r},e))}).catch(function(e){c.has(r)&&(a.signal.removeEventListener("abort",o),f(c,r),e&&"AbortError"===e.name||s._post({type:v,jobId:r,error:d.toInvokeError(e||{message:"Error encountered at method "+n})}))})):this._post({type:v,jobId:r},t)},i.prototype._onOpenPort=function(e){var t=new MessageChannel;new i(t.port1,this._client),this._post({type:v,jobId:e.jobId},t.port2,[t.port2])},i.prototype._onResponse=function(e){var t=e.jobId,o=e.error,s=e.data,n=this._outJobs;n.has(t)&&(e=n.get(t),f(n,t),o?e.reject(c.fromJSON(JSON.parse(o))):e.resolve(s))},i.prototype._post=function(e,t,o){return d.postMessage(this._port,e,t,o)},i;function i(e,t,o){var s=this;this._outJobs=new Map,this._inJobs=new Map,this._queue=new n(function(e){return s._onInvoke(e)}),this._onMessage=this._onMessage.bind(this),this._client=t,this._port=e,this._port.addEventListener("message",this._onMessage),this._port.start(),this._channel=o}});