define(["dojo/Evented","../core/declare","dojo/Deferred","dojo/request","../core/has","../core/urlUtils","require"],function(e,t,o,r,s,n,i){var a=window.Blob||window.webkitBlob||window.mozBlob,c=window.URL||window.webkitURL||window.mozURL;return t([e],{declaredClass:"esri.workers.WorkerClient",worker:null,_queue:null,constructor:function(e,t){this._isIE=s("ie"),this._queue={},this._acceptMessage=this._acceptMessage.bind(this),this._errorMessage=this._errorMessage.bind(this),e&&this.setWorker(e,function(e){this.worker=e,t(this)}.bind(this))},setWorker:function(e,t){var r;e instanceof Array&&(e=(r=e).shift());var s,o=this._getUrl(e),o=n.normalize(o),i=!n.hasSameOrigin(o,location.href);if(!1===o)return console.log("Can not resolve worker path"),!1;if(this.worker&&((s=this.worker).removeEventListener("message",this._acceptMessage,!1),s.removeEventListener("error",this._errorMessage,!1),s.terminate(),s=null),i){i=this._getUrl("./mutableWorker",!0);try{this._getRemoteText(i,function(e){e=c.createObjectURL(new a([e],{type:"text/javascript"}));t(this._createWorker(e,o))}.bind(this))}catch(e){try{i=n.getProxyUrl(i).path+"?"+encodeURI(i),this._useProxy=!0,t(this._createWorker(i,r))}catch(e){return console.log("Can not create worker"),!1}}}else t(this._createWorker(o,r))},_createWorker:function(e,t){e=new Worker(e);return e.addEventListener("message",this._acceptMessage,!1),e.addEventListener("error",this._errorMessage,!1),this.worker=e,t&&this.importScripts(t),e},postMessage:function(e,t){(e instanceof Array||"object"!=typeof e)&&(e={data:e});var r=Math.floor(64e9*Math.random()).toString(36);e.msgId=r;r=this._queue[r]=new o;return this.worker?(t?this.worker.postMessage(e,t):this.worker.postMessage(e),this.emit("start-message",{target:this,message:e})):r.reject({message:"No worker was set."}),r.promise},terminate:function(){var e=Object.keys(this._queue);this.worker&&this.worker.terminate();for(var t=e.length-1;0<=t;t--)this._queue[e[t]].cancel("terminated"),delete this._queue[e[t]]},addWorkerCallback:function(e,t){var r,s=this._getUrl(e,!0);return!1===s?((r=new o).reject({message:"Could not load text from "+e}),r.promise):this.postMessage({action:"add-callback",url:s,cbName:t||"main"}).then(function(e){(e.target=this).emit("callback-added",e)}.bind(this))},importScripts:function(e){e=(e=!Array.isArray(e)?[e]:e).map(function(e){e=this._getUrl(e,!0);return e=this._useProxy&&!n.hasSameOrigin(e,location.href)?n.getProxyUrl(e).path+"?"+encodeURI(e):e},this);return this.postMessage({action:"import-script",url:e}).then(function(e){(e.target=this).emit("scripts-imported",e)}.bind(this))},_acceptMessage:function(e){var t,r=e.data,s=r.msgId;r.status&&"debug"==r.status?(t=r.showAs||"debug",console[t](r)):s&&s in this._queue&&(t=this._queue[s],"progress"==r.status?t.progress(e.data):("error"==r.status?t.reject(e.data):t.resolve(e.data),delete this._queue[s])),this.emit("message",{message:e.data,event:e,target:this})},_errorMessage:function(e){this.onerror||this.onError?this.onerror?this.onerror(e):this.onError(e):console.log("Worker Error: "+e.message+"\nIn "+e.filename+" on "+e.lineno)},_getUrl:function(e,t){if(!e)return console.error("can not resolve empty path"),!1;e.match(/\.js$/)||(e+=".js");e=i.toUrl(e);return t?n.makeAbsolute(e):e},_getRemoteText:function(e,t){(e=this._getUrl(e))&&r.get(e,{sync:!1,handleAs:"text",headers:{"X-Requested-With":"","Content-Type":"text/plain"}}).then(function(e){t(e)})},_startBlobWorker:function(){var e,t=this._xdSource;t||(e=this._getUrl("./mutableWorker"),e=new a(["if(!self._mutable){importScripts('"+e+"');}"],{type:"text/javascript"}),t=this._xdSource=c.createObjectURL(e));try{return new Worker(t)}catch(t){return console.log(t.message),!1}}})});